---
title: "MI vs Sham RNA-seq Workflow â€” Reproducible Notebook"
author: "Aslihan Bilikci"
year: "2025"
output:html_document
---

#Environment Setup: knitr Options & Seed

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.align = "center")
set.seed(42)
```

#Reproducibility & Environment

```{r reproducibility}
 install.packages("renv")
 renv::init()
 sessionInfo()
```


# 2. Installation and Loading

```{r packages, message=TRUE}
req <- c("BiocManager","tximport","DESeq2","biomaRt","readr","readxl","dplyr","tibble",
         "ggplot2","ggplotify","pheatmap","RColorBrewer","data.table","umap","Rtsne",
         "fgsea","AnnotationDbi","org.Mm.eg.db","EnrichmentBrowser", "apeglm", "EnrichmentBrowser")
to_install <- setdiff(req, rownames(installed.packages()))
if (length(to_install)) {
  BiocManager::install(to_install, ask=FALSE, update=FALSE)
}
invisible(lapply(req, require, character.only=TRUE))
```

```{r biomaRt-annotation}
# Customize: species may be mouse (mmusculus) or human (hsapiens)
ensembl <- biomaRt::useMart("ensembl")
ensembl <- biomaRt::useDataset("mmusculus_gene_ensembl", mart = ensembl)
tx_annot <- biomaRt::getBM(
  attributes = c("ensembl_transcript_id", "ensembl_gene_id","external_gene_name","description"),
  filters = "biotype", values = "protein_coding", mart = ensembl
)
tx2gene <- unique(tx_annot[,c("ensembl_transcript_id","ensembl_gene_id")])
save(tx_annot, file="Transcript_Annotation.Rda")
head(tx_annot)
```

# 3. Import Quantifications (Kallisto)

```{r file-map}
# Map sample files; ensure names reflect your design (Treatment_Time_Rep)
sra_accession <- rev(dir("abundances/"))
files <- sort(file.path("abundances", sra_accession, "abundance.h5"))
names(files) <- c("sham_1dMI_1","sham_1dMI_2","MI_1dMI_1","MI_1dMI_2",
                  "sham_3dMI_1","sham_3dMI_2","MI_3dMI_1","MI_3dMI_2")
stopifnot(all(file.exists(files)))
```

```{r tximport}
txi <- tximport(files, type="kallisto", txOut=FALSE, tx2gene=tx_annot, ignoreTxVersion=TRUE)
mat.count <- round(txi$counts)
mat.tpm   <- txi$abundance

head(mat.count)
head(mat.tpm)
```

# 4. Sample Metadata (Design Matrix)

```{r design}
mat.design <- data.frame(
  SRA_accession = sra_accession,
  Sample_name   = colnames(mat.count),
  Treatment     = sapply(strsplit(colnames(mat.count), "_"), `[`, 1),
  Time          = sapply(strsplit(colnames(mat.count), "_"), `[`, 2),
  Replicate     = sapply(strsplit(colnames(mat.count), "_"), `[`, 3),
  stringsAsFactors = FALSE
) |>
  dplyr::mutate(
    Treatment = factor(Treatment, levels=c("sham","MI")),
    Time = factor(Time, levels=c("1dMI","3dMI")),
    Replicate = factor(Replicate)
  )
mat.design
```

# 5. QC & Normalization

```{r qc}
# Library sizes
libsizes <- colSums(mat.count)
knitr::kable(data.frame(Sample=names(libsizes), LibrarySize=libsizes), caption="Library sizes")

# VST / rlog
dds0 <- DESeqDataSetFromMatrix(countData = mat.count, colData = mat.design, design = ~ 1)
dds0 <- estimateSizeFactors(dds0)
vsd  <- vst(dds0, blind=TRUE)
vmat <- assay(vsd)
```

# 6. Highly Variable Genes (HVGs)

```{r hvg}
# Mean-variance trend and top HVGs
m <- rowMeans(vmat)
v <- matrixStats::rowVars(vmat)
z <- (v - median(v)) / mad(v)
ord <- order(z, decreasing = TRUE)
topk <- 1000
hvg <- rownames(vmat)[ord[seq_len(min(topk, nrow(vmat)))]]
vmat_hvg <- vmat[hvg,]
```

# 7. Dimensionality Reduction

```{r pca}
p <- prcomp(t(vmat_hvg), scale.=FALSE)
autoplot <- ggplot2::autoplot
# If ggfortify isn't installed, switch to a manual ggplot
df_pca <- data.frame(PC1=p$x[,1], PC2=p$x[,2], mat.design)
ggplot(df_pca, aes(PC1, PC2, color=Treatment, shape=Time, label=Sample_name)) +
  geom_point(size=3, alpha=0.9) + ggrepel::geom_text_repel(size=3) +
  labs(title="PCA on HVGs") + theme_minimal()
```

```{r tsne, warning=FALSE, message=FALSE}
set.seed(42)
ts <- Rtsne(t(vmat_hvg), perplexity = 2)
df_tsne <- data.frame(tSNE1 = ts$Y[,1], tSNE2 = ts$Y[,2], mat.design)
ggplot(df_tsne, aes(tSNE1, tSNE2, color=Treatment, shape=Time)) +
  geom_point(size=3, alpha=0.9) +
  labs(title="t-SNE on HVGs", x="t-SNE 1", y="t-SNE 2") +
  theme_minimal()
```

# 8. Differential Expression (DESeq2)

```{r deseq2}
#convert to DESeqDataSet format
dds <- DESeqDataSetFromMatrix(countData = mat.count,
                              colData   = mat.design,
                              design    = ~ Time + Treatment)
dds <- DESeq(dds)
res_MI_vs_sham <- results(dds, contrast = c("Treatment","MI","sham"))
res_MI_vs_sham <- lfcShrink(dds, coef="Treatment_sham_vs_MI", type="apeglm")
summary(res_MI_vs_sham)


```


# 9. Pathway Enrichment (fgsea)


```{r fgsea}
library(fgsea)
library(dplyr)

# Step 1: Load your differential expression results
#res_MI_vs_sham <- read.csv("res_MI_vs_sham.csv", row.names = 1)

# Step 2: Prepare the ranks vector
ranks <- round(res_MI_vs_sham$log2FoldChange)
names(ranks) <- rownames(res_MI_vs_sham)
ranks <- ranks[is.finite(ranks)]

# Step 3: Load the pathway file with gene SYMBOLs
pathways <- gmtPathways("m2.cp.v2025.1.Mm.entrez.gmt")

# Step 4: Run fgsea enrichment
fg <- fgsea(pathways = pathways, stats = ranks, nperm = 10000)

# Step 5: Show top pathways by adjusted p-value
fg |> arrange(padj) |> head()

```

# 10. Reporting & Reproducibility

```{r export}
dir.create("results", showWarnings = FALSE)
# Example exports:
 readr::write_csv(as.data.frame(res_MI_vs_sham), "results/DE_MI_vs_sham.csv")
 saveRDS(list(hvg=hvg, pca=p, tsne=ts), file="results/objects.rds")
```

# 11. References
## References

Sysmedicine. (2022). *KCLModule2_2022: Metagenomics statistics 2022* [Computer software]. GitHub.  
https://github.com/sysmedicine/KCLModule2_2022/tree/main/Metagenomics_Statistics_2022



